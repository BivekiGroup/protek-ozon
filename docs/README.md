# Проект: Интеграция с Ozon Seller API (демо)

Этот проект — демо-приложение на Next.js с интеграцией к Ozon Seller API. За 2 рабочих дня мы:

- Подключили и унифицировали запросы к Ozon (общий клиент `ozonPost`).
- Добавили прокси-роуты к методам Ozon: список товаров, детали, характеристики.
- Реализовали главную страницу со списком товаров, карточку товара, демо-страницу.
- Полностью русифицировали UI и серверные сообщения.
- Добавили форматирование цен и дат, фильтры и поиск, сортировку, бесконечную прокрутку.
- Ввели легкую валидацию входных данных и мягкое кеширование.
- Улучшили UX: превью PDF, «копировать SKU/артикул», скелетоны загрузки.

## Технологии

- Next.js App Router (React 19)
- TypeScript
- Tailwind + утилиты из `@/components/ui/*` (готовые UI-компоненты)

## Структура

- `src/app/` — страницы и серверные роуты
  - `page.tsx` — главная со списком товаров
  - `product/[id]/` — карточка товара (страница + клиентская логика)
  - `api/ozon/products` — прокси к `POST /v3/product/list`
  - `api/ozon/products/info` — прокси к `POST /v3/product/info/list`
  - `api/ozon/products/attributes` — прокси к `POST /v4/product/info/attributes`
  - `ozon/products` — альтернативная демо-страница
- `src/lib/`
  - `ozon.ts` — общий клиент `ozonPost` для запросов к Ozon
  - `format.ts` — форматирование цен/дат
  - `ozon-attrs.ts` — маппинг ID характеристик в читаемые названия
- `src/types/ozon.ts` — основные типы ответа Ozon

## Переменные окружения

Создайте `.env` или `.env.local`:

```
OZON_CLIENT_ID=ваш_client_id
OZON_API_KEY=ваш_api_key
```

Они используются только на сервере (в API-роутах) и не утекут в клиент.

## Запуск

- Установить зависимости: `npm i`
- Запустить дев-сервер: `npm run dev`
- Открыть `http://localhost:3000`

## API-роуты (прокси)

Все роуты ожидают `application/json` и возвращают JSON.

- `POST /api/ozon/products` → `https://api-seller.ozon.ru/v3/product/list`
  - Тело: `{ filter?: object; last_id?: string; limit?: number }`
  - Валидация: `limit` 1..1000, `last_id` — строка
  - Кеш: `revalidate: 30`

- `POST /api/ozon/products/info` → `/v3/product/info/list`
  - Тело: `{ product_id?: string[]; offer_id?: string[]; sku?: string[] }`
  - Нормализация массивов к строкам

- `POST /api/ozon/products/attributes` → `/v4/product/info/attributes`
  - Тело: `{ filter?: object; last_id?: string; limit?: number; sort_by?: string; sort_dir?: string }`
  - Валидация: `limit` 1..1000; `sort_dir` нормализуется `asc|desc` → `ASC|DESC`

Ошибки API отдаются на русском: `{ error, status, statusText, data }`.

## Страницы

- Главная `/`
  - Список товаров Ozon
  - Фильтры: Видимость (`ALL|VISIBLE|INVISIBLE`), артикул (`offer_id`), `SKU`
  - Клиентский фильтр по названию
  - Сортировка атрибутов (`sku|offer_id|id|title` + `asc|desc`)
  - Бесконечный скролл (подгрузка по `last_id`)
  - Форматирование цен (`ru-RU` + `RUB`) и дат
  - Значки для архивов, скидок, FBO/FBS
  - Переход к карточке товара

- Карточка товара `/product/[id]`
  - Вкладки: Инфо, Габариты, Статусы, Остатки, Характеристики, Сырой ответ
  - Показываются изображения (галерея), цены с форматированием и даты
  - Характеристики с читаемыми названиями (маппинг `attribute_id`)
  - Превью PDF (`pdf_list`)
  - Кнопки: «Скопировать SKU», «Скопировать артикул»

- Демо `/ozon/products`
  - Альтернативная страница списка, с сортировкой атрибутов и форматированием

## Поведение и решения

- Пагинация: Ozon использует курсор `last_id`. На главной реализован бесконечный скролл (IntersectionObserver) и аккумуляция карточек. Можно добавить кнопку «Новый поиск», чтобы сбрасывать список при изменении фильтров.
- Кеширование: для списка — `revalidate: 30`; детали/атрибуты — без кеша для актуальности.
- Валидация: простая ручная проверка на сервере; при необходимости можно заменить на Zod.
- Форматирование: `Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' })` и `Intl.DateTimeFormat('ru-RU', ...)`.
- Локализация: все пользовательские тексты и сообщения об ошибках на русском.

## Известные ограничения

- Нет «номеров страниц», т.к. курсорная пагинация (только `last_id`).
- Поиск по названию реализован на клиенте — зависит от пришедших данных и пагинации.
- Маппинг характеристик покрывает популярные `attribute_id` (расширяется при необходимости).

## Примеры

- Загрузка списка товаров (все видимые):

```bash
curl -s http://localhost:3000/api/ozon/products \
  -H 'Content-Type: application/json' \
  -d '{"filter":{"visibility":"ALL"},"limit":100}' | jq .
```

- Информация о товарах по `product_id`:

```bash
curl -s http://localhost:3000/api/ozon/products/info \
  -H 'Content-Type: application/json' \
  -d '{"product_id":["213761435"]}' | jq .
```

- Характеристики с сортировкой:

```bash
curl -s http://localhost:3000/api/ozon/products/attributes \
  -H 'Content-Type: application/json' \
  -d '{"filter":{"product_id":["213761435"],"visibility":"ALL"},"limit":100,"sort_by":"sku","sort_dir":"asc"}' | jq .
```

## Roadmap / Идеи улучшений

- Кнопка «Новый поиск» (сброс аккумуляции при изменении фильтров)
- Больше полей сортировки/фильтрации (если поддерживает Ozon)
- Расширение словаря характеристик и человекочитаемых единиц измерения
- Серверная фильтрация по названию (при наличии подходящего эндпоинта)
- Экспорт списка в CSV/Excel
- Покрытие критичных частей e2e-тестами

## Changelog за 2 дня

- День 1:
  - Базовый список товаров и карточка товара
  - Прокси к `/v3/product/list`, `/v3/product/info/list`
  - Базовый UI с карточками, изображениями, ценами
- День 2:
  - Интеграция `/v4/product/info/attributes`
  - Общий клиент `ozonPost`
  - Полная русификация
  - Форматирование цен/дат
  - Фильтры (видимость, offer_id, sku), поиск по названию (клиентский)
  - Сортировка атрибутов, бесконечный скролл
  - Лёгкая серверная валидация и мягкий кеш
  - UX: PDF-превью, копирование SKU/артикула

